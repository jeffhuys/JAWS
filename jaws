#!/usr/bin/env node
const program = require('commander-plus')
const chalk = require ('chalk')
const prettyjson = require ('prettyjson')
const package = require ('./package.json')

const _find = require ('lodash.find')
const _forEach = require ('lodash.foreach')

const AWS = require('aws-sdk')

AWS.config.update({ region: 'eu-west-1' })

let ecs = new AWS.ECS()

const silent = '-S, --silent Suppress any non-JSON output'

program
  .version (package.version)
  .usage   ('<command> [options]')
  .option  (silent)

program
  .command('*')
  .action(function (env) {
    errorLog(`Unknown command: ${env}`)
  })

program
  .command('env')
    .description('Environment actions')
    .option('-T, --taskdef [taskdef] <required>')
    .option('-v, --variable [variable]')
    .option('-s, --set [value]')
    .option('-p, --pretty', `Enable pretty rendering of JSON objects (not for use with pipe!)`)
    .option(silent)
    .action(function(env) { envCommand(env) })

// Extend help
program
  .on ('--help', () => {
    console.log('  Examples:')
    console.log('')
    console.log('    $ jaws env -T www-bleeve-nl')
    console.log('    $ jaws env -T www-bleeve-nl -v BLEEVE_APIBASEURL')
    console.log('')
  })

program
  .parse (process.argv)

// If no args given, display help and exit
if (process.argv.length === 2) program.help()


async function envCommand (env) {

  if (!env.taskdef) errorLog('No task definition supplied.', true)

  const taskDefinition = (await describeTaskDefinition( { taskDefinition: env.taskdef } )).taskDefinition

  if (!env.variable)

    // No particular variable given
    printObj ( taskDefinition.containerDefinitions[0].environment, env.pretty )

  else {

    // Variable actions
    // TODO: SET
    const envVar = _find (taskDefinition.containerDefinitions[0].environment, {name: env.variable})

    if (envVar)

      printObj ( { [env.variable]: envVar.value }, env.pretty )

    else

      errorLog ( `Variable not found: ${ env.variable }` )

  }

}




function describeTaskDefinition( args ) {
  return new Promise( function(resolve, reject) {
    ecs.describeTaskDefinition ( args, function (err, data) {
      return err ? reject (err) : resolve (data)
    })
  })
}

function isEmptyObject (obj) {
  return !Object.keys(obj).length;
}

function printObj (obj, pretty) {
  if (pretty) console.log (prettyjson.render (obj))
  else        console.log (JSON.stringify (obj))
}

function errorLog (err, exit) {
  if (err.code) console.log (chalk.red.bold('ERROR:'), err.code)
  if (err.message) console.log (err.message)
  else console.log (chalk.red.bold (err))
  
  if (exit) process.exit(-1)
}

function debugLog() {
  /*if (!args.quiet) */console.log.apply(console.log, arguments)
}